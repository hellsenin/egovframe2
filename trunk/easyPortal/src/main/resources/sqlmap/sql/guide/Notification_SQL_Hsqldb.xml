<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<!-- TODO [Step 4-4] SqlMap 파일 확인 -->
<!-- <select ../>, <insert ../>, <update ../> 등을 통해 Query 작성  -->
<!-- 각 statement에 대한 input(parameterClass)과 output(resultClass 또는 resultMap)이 정의됨  -->
<!-- dynamic query를 통해 다양한 조건을 처리할 수 있음 -->
<!-- DAO에서 query id에 의해 호출됨 -->
<sqlMap namespace="Notification">

	<typeAlias  alias="notificationVO" type="egovframework.gettingstart.guide.service.NotificationVO"/>

	<resultMap id="notificationList" class="egovframework.gettingstart.guide.service.NotificationVO">
		<result property="notificationId" column="ID" columnIndex="1"/>
		<result property="notificationSubject" column="SUBJECT" columnIndex="2"/>
		<result property="notificationContents" column="CONTENTS" columnIndex="3"/>
		<result property="notificationTime" column="DATE_TIME" columnIndex="4"/>
		<result property="intervalString" column="INTERVAL" columnIndex="5"/>
		<result property="registerDateTime" column="REGISTER_DATETIME" columnIndex="6"/>
	</resultMap>

	<resultMap id="notificationDetail" class="egovframework.gettingstart.guide.service.NotificationVO">
		<result property="notificationId" column="ID" columnIndex="1"/>
		<result property="notificationSubject" column="SUBJECT" columnIndex="2"/>
		<result property="notificationContents" column="CONTENTS" columnIndex="3"/>
		<result property="notificationTime" column="DATE_TIME" columnIndex="4"/>
		<result property="intervalString" column="INTERVAL" columnIndex="5"/>
		<result property="registerUserId" column="REGISTER_ID" columnIndex="6"/>
		<result property="registerUserName" column="REGISTER_NAME" columnIndex="7"/>
		<result property="registerDateTime" column="REGISTER_DATETIME" columnIndex="8"/>
	</resultMap>
	
	<!--
	TO_CHAR(TO_TIMESTAMP(a.DATE_TIME, 'YYYYMMDDHH24MISS'), 'YYYY-MM-DD HH24:MI:SS') as DATE_TIME, 
	 -->

	<select id="NotificationDAO.selectNotificationList" parameterClass="notificationVO" resultMap="notificationList" >
		<![CDATA[
			SELECT 
				a.ID, a.SUBJECT, a.CONTENTS,
				SUBSTR(a.DATE_TIME, 1, 4)||'-'||SUBSTR(a.DATE_TIME, 5, 2)||'-'||SUBSTR(a.DATE_TIME, 7, 2)||' '||
				SUBSTR(a.DATE_TIME, 9, 2)||':'||SUBSTR(a.DATE_TIME, 11, 2)||':'||SUBSTR(a.DATE_TIME, 13, 2)	as DATE_TIME, 
				REPLACE(INTERVAL,',','$minuteLabel$,') || '$minuteLabel$' as INTERVAL,
				TO_CHAR(a.REGISTER_DATETIME, 'YYYY-MM-DD') as REGISTER_DATETIME
			FROM
				NOTIFICATION a
			WHERE 1=1	
		]]>
			<isEqual prepend="AND" property="searchCnd" compareValue="0">
				<![CDATA[	a.DATE_TIME LIKE #searchWrd# || '%' 		]]>
			</isEqual>
			<isEqual prepend="AND" property="searchCnd" compareValue="1">
				<![CDATA[	a.SUBJECT LIKE '%' || #searchWrd# || '%' 		]]>
			</isEqual>	
			<isEqual prepend="AND" property="searchCnd" compareValue="2">
				<![CDATA[	a.CONTENTS LIKE '%' || #searchWrd# || '%' 		]]>
			</isEqual>
		<![CDATA[			
			ORDER BY a.REGISTER_DATETIME DESC 
			LIMIT #recordCountPerPage# OFFSET #firstIndex#
		]]>				
	</select>	
	
	<select id="NotificationDAO.selectNotificationListCnt" parameterClass="notificationVO" resultClass="java.lang.Integer" >
		<![CDATA[
			SELECT 
				COUNT(a.ID)
			FROM
				NOTIFICATION a
			WHERE 1=1 
		]]>
			<isEqual prepend="AND" property="searchCnd" compareValue="0">
				<![CDATA[	a.DATE_TIME LIKE #searchWrd# || '%' 		]]>
			</isEqual>
			<isEqual prepend="AND" property="searchCnd" compareValue="1">
				<![CDATA[	a.SUBJECT LIKE '%' || #searchWrd# || '%' 		]]>
			</isEqual>	
			<isEqual prepend="AND" property="searchCnd" compareValue="2">
				<![CDATA[	a.CONTENTS LIKE '%' || #searchWrd# || '%' 		]]>
			</isEqual>
	</select>

	<insert id="NotificationDAO.insertNotification" parameterClass="notificationVO" >
		<selectKey resultClass="java.lang.String" keyProperty="notificationId">
			SELECT IFNULL(MAX(ID),0)+1 AS ID FROM NOTIFICATION
		</selectKey>
		<![CDATA[
			INSERT INTO NOTIFICATION
			(ID, SUBJECT, CONTENTS,
			 DATE_TIME, INTERVAL,
			 REGISTER_ID, REGISTER_DATETIME )
			VALUES
			( #notificationId#, #notificationSubject#, #notificationContents#, #notificationTime#, #intervalString#, 
			  #registerUserId#, CURRENT_TIMESTAMP
			 )			
		]]>
	</insert>
 
	<select id="NotificationDAO.selectNotification" parameterClass="notificationVO" resultMap="notificationDetail" >
		<!-- TODO 등록자 이름 처리  -->
		<![CDATA[
			SELECT 
				a.ID, a.SUBJECT, a.CONTENTS,
				SUBSTR(a.DATE_TIME, 1, 4)||'-'||SUBSTR(a.DATE_TIME, 5, 2)||'-'||SUBSTR(a.DATE_TIME, 7, 2)||' '||
				SUBSTR(a.DATE_TIME, 9, 2)||':'||SUBSTR(a.DATE_TIME, 11, 2)||':'||SUBSTR(a.DATE_TIME, 13, 2)	as DATE_TIME, 
				REPLACE(INTERVAL,',','$minuteLabel$,') || '$minuteLabel$' as INTERVAL,
				a.REGISTER_ID, '홍길동' as REGISTER_NAME,
				TO_CHAR(a.REGISTER_DATETIME, 'YYYY-MM-DD HH24:MI:SS') as REGISTER_DATETIME
			FROM
				NOTIFICATION a				
			WHERE a.ID = #notificationId#
		]]>				
	</select> 
 
 	<update id="NotificationDAO.updateNotification" parameterClass="notificationVO">
 		<![CDATA[
			UPDATE NOTIFICATION SET 
				SUBJECT = #notificationSubject#,
				CONTENTS = #notificationContents#, 
				DATE_TIME = #notificationTime#,
				INTERVAL = #intervalString#,
				UPDATE_ID = #updateUserId#,
				UPDATE_DATETIME = CURRENT_TIMESTAMP
			WHERE ID = #notificationId#
 		]]>
 	</update>

 	<update id="NotificationDAO.deleteNotification" parameterClass="notificationVO">
 		<![CDATA[
			DELETE FROM NOTIFICATION
			WHERE ID = #notificationId#
 		]]>
 	</update>

	<select id="NotificationDAO.getNotificationData" parameterClass="notificationVO" resultMap="notificationList" >
		<![CDATA[
			SELECT 
				a.ID, a.SUBJECT, a.CONTENTS,
				SUBSTR(a.DATE_TIME, 1, 4)||'-'||SUBSTR(a.DATE_TIME, 5, 2)||'-'||SUBSTR(a.DATE_TIME, 7, 2)||' '||
				SUBSTR(a.DATE_TIME, 9, 2)||':'||SUBSTR(a.DATE_TIME, 11, 2)||':'||SUBSTR(a.DATE_TIME, 13, 2)	as DATE_TIME, 				
				INTERVAL as INTERVAL,
				TO_CHAR(a.REGISTER_DATETIME, 'YYYY-MM-DD HH24:MI:SS') as REGISTER_DATETIME
			FROM
				NOTIFICATION a
			WHERE a.DATE_TIME BETWEEN #startDateTime# AND #endDateTime#
		]]>	
		<![CDATA[			
			ORDER BY a.DATE_TIME ASC 
		]]>				
	</select>
</sqlMap>
